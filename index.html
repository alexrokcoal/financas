<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Exemplo Login Google + Proxy Worker</title>
</head>
<body>
  <h1>Autenticação Google</h1>
  <div id="buttonDiv"></div>
  <button id="callApi">Chamar API Protegida</button>
  <pre id="output"></pre>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    const CLIENT_ID = "954634376637-r0qfsdbjbqpbrr13pi9tu93j8gu65056.apps.googleusercontent.com"; // substitua

    // Callback chamado quando o usuário faz login (recebe ID Token)
    function handleCredentialResponse(response) {
      // response.credential é o ID token (JWT)
      window.sessionStorage.setItem("google_id_token", response.credential);
      document.getElementById("output").textContent =
        "Logado. ID token salvo em sessionStorage (válido ~1h).";
    }

    window.onload = () => {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse,
      });

      google.accounts.id.renderButton(
        document.getElementById("buttonDiv"),
        { theme: "outline", size: "large" }
      );
    };

    document.getElementById("callApi").addEventListener("click", async () => {
      const token = window.sessionStorage.getItem("google_id_token");
      if (!token) {
        alert("Faça login primeiro.");
        return;
      }

      try {
        const res = await fetch("https://gas-proxy.alexro-kcoal.workers.dev/", {
          method: "GET",
          headers: {
            "Authorization": "Bearer " + token,
            "Accept": "application/json"
          },
          // include credentials only if you need cookies; for tokens, not needed
        });

        const text = await res.text();
        document.getElementById("output").textContent = `Status: ${res.status}\n\n${text}`;
      } catch (err) {
        document.getElementById("output").textContent = "Erro: " + String(err);
      }
    });
  </script>
</body>
</html>
